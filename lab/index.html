<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WeatherWise Color Lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../main.css">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon.png">
<link rel="apple-touch-icon" href="../favicon.png">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">


<style>

</style>
</head>
<body class="lab-page">

  <header>
<a href="https://web.weatherwise.app/" target="_blank" rel="noopener noreferrer" class="live-indicator">
  <span class="dot"></span>
  LIVE RADAR
</a>
<a href="https://web.weatherwise.app/" target="_blank" rel="noopener noreferrer" class="live-indicator">
  <span class="dot"></span>
  LIVE RADAR
</a>
<a href="/colortables/" class="logo-link">
  <h1 class="logo-heading">
    <img src="https://www.weatherwise.app/img/logo.svg" alt="WeatherWise logo">
    <span class="brand">
      Weather<span class="accent">Wise</span>
    </span>
    Color Tables
  </h1>
<div class="title-sub">BY ALMANY DESIGNS</div>
</a>



<nav>
  <a href="https://balmany15.github.io/colortables/?category=reflectivity" class="nav-btn">âš¡Reflectivity</a>
  <a href="https://balmany15.github.io/colortables/?category=velocity" class="nav-btn">ğŸŒªï¸Velocity</a>
  <a href="https://balmany15.github.io/colortables/?category=ptype" class="nav-btn">ğŸŒ¨ï¸Precipitation Type</a>

  <a href="../how-to/" class="nav-btn">ğŸ“How To</a>
  <a href="../submit/" class="nav-btn">ğŸ“¥Submit</a>
  <a href="../lab/" class="nav-btn active">ğŸ§ªColor Lab</a>
</nav>


  </header>
<main>
  <div class="container">

<h1 class="lab-title">
  ğŸ§ªCOLOR LAB
</h1>


    <div id="preview" class="preview"></div>

    <div id="legend" class="legend"></div>

    <div class="meta">
      <input id="product" placeholder="Product (BR)">
      <input id="units" placeholder="Units (dBZ)">
      <input id="scale" placeholder="Scale (optional)">
      <input id="offset" placeholder="Offset (optional)">
      <input id="step" placeholder="Step (optional)">
    </div>

    <div id="rows" class="rows"></div>

    <div class="controls">
      <button onclick="addRow()">Add Row</button>
      <button onclick="downloadPAL()">Download .PAL</button>
    </div>

  </div>
</main>


<script>
const rowsContainer=document.getElementById("rows");

const preview=document.getElementById("preview");

const ticksContainer = document.getElementById("legend");


const defaultTable = [
  { value: 0,   type: "color4",  start: {r:0,g:215,b:130,a:0} },
  { value: 10,  type: "color",  start: {r:0,g:215,b:130}, end:{r:0,g:75,b:0} },
  { value: 35,  type: "color",  start: {r:255,g:255,b:33} },
  { value: 42,  type: "color",  start: {r:255,g:155,b:0} },
  { value: 45,  type: "color",  start: {r:255,g:0,b:0}, end:{r:150,g:0,b:0} },
  { value: 55,  type: "color",  start: {r:175,g:0,b:150} },
  { value: 60,  type: "color",  start: {r:230,g:100,b:230} },
  { value: 70,  type: "color",  start: {r:0,g:0,b:0} },
  { value: 90,  type: "solid",  start: {r:255,g:255,b:255} }
];


function rgbToHex(r,g,b){
  return "#"+[r,g,b].map(x=>{
    const h=parseInt(x).toString(16);
    return h.length===1?"0"+h:h;
  }).join("");
}

function hexToRgb(hex){
  const result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result?{
    r:parseInt(result[1],16),
    g:parseInt(result[2],16),
    b:parseInt(result[3],16)
  }:null;
}

function createColorSet(container, data, withAlpha = false) {

  const picker = document.createElement("input");
  picker.type = "color";
  picker.className = "picker";

  const hexInput = document.createElement("input");
  hexInput.type = "text";
  hexInput.className = "hex";

  const rInput = document.createElement("input");
  rInput.type = "number";
  rInput.className = "r";
  rInput.min = 0;
  rInput.max = 255;

  const gInput = document.createElement("input");
  gInput.type = "number";
  gInput.className = "g";
  gInput.min = 0;
  gInput.max = 255;

  const bInput = document.createElement("input");
  bInput.type = "number";
  bInput.className = "b";
  bInput.min = 0;
  bInput.max = 255;

  container.append(picker, hexInput, rInput, gInput, bInput);
  

  let aInput = null;

  if (withAlpha) {
    aInput = document.createElement("input");
    aInput.type = "number";
    aInput.className = "a";
    aInput.min = 0;
    aInput.max = 255;
    container.append(aInput);
  }

  function syncFromRGB() {
    const hex = rgbToHex(rInput.value || 0, gInput.value || 0, bInput.value || 0);
    picker.value = hex;
    hexInput.value = hex;
    updatePreview();
  }

  function syncFromHEX() {
    const rgb = hexToRgb(hexInput.value);
    if (rgb) {
      rInput.value = rgb.r;
      gInput.value = rgb.g;
      bInput.value = rgb.b;
      picker.value = hexInput.value;
      updatePreview();
    }
  }

  function syncFromPicker() {
    const rgb = hexToRgb(picker.value);
    rInput.value = rgb.r;
    gInput.value = rgb.g;
    bInput.value = rgb.b;
    hexInput.value = picker.value;
    updatePreview();
  }

  // Initial values
  rInput.value = data.r;
  gInput.value = data.g;
  bInput.value = data.b;
  if (aInput) aInput.value = data.a ?? 255;

  syncFromRGB();

  // ğŸ”¥ IMPORTANT â€” use change for picker (not input)
  picker.addEventListener("change", syncFromPicker);

  rInput.addEventListener("input", syncFromRGB);
  gInput.addEventListener("input", syncFromRGB);
  bInput.addEventListener("input", syncFromRGB);
  if (aInput) aInput.addEventListener("input", updatePreview);

  hexInput.addEventListener("input", () => {
    if (/^#([0-9A-F]{6})$/i.test(hexInput.value)) {
      syncFromHEX();
    }
  });
}



function addRow(data){
  const row=document.createElement("div");
  row.className="row";

  row.innerHTML=`
    <input type="number" class="value" placeholder="Value">
    <select class="mode">
      <option value="color" selected>Color</option>
      <option value="solid">Solid</option>
      <option value="color4">Color4</option>
      <option value="solid4">Solid4</option>
    </select>
  `;


  const valueInput=row.querySelector(".value");
  valueInput.addEventListener("input", updatePreview);
valueInput.addEventListener("change", updatePreview);
valueInput.addEventListener("blur", () => {
  sortRows();
  updatePreview();
});


  const modeSelect=row.querySelector(".mode");

  if(data){
    valueInput.value=data.value;
    modeSelect.value=data.type;
  }

// START COLOR SET
const startSet = document.createElement("div");
startSet.className = "color-set";

function rebuildStartSet() {
  startSet.innerHTML = "";   // ğŸ”¥ CLEAR OLD INPUTS FIRST

  const withAlpha = modeSelect.value === "color4" || modeSelect.value === "solid4";

  createColorSet(
    startSet,
    data ? data.start : { r: 0, g: 215, b: 130, a: 255 },
    withAlpha
  );
}


rebuildStartSet();
row.appendChild(startSet);


  // USE END CHECKBOX (RIGHT AFTER START COLOR)
  const endWrapper=document.createElement("label");
  endWrapper.style.display="flex";
  endWrapper.style.alignItems="center";
  endWrapper.style.gap="6px";
  endWrapper.style.marginLeft="10px";

  const endToggle=document.createElement("input");
  endToggle.type="checkbox";
  endToggle.className="useEnd";

  const endText=document.createElement("span");
  endText.textContent="End Color";

  endWrapper.appendChild(endToggle);
  endWrapper.appendChild(endText);

  row.appendChild(endWrapper);

  // END COLOR SET (INLINE, HIDDEN BY DEFAULT)
  const endSet=document.createElement("div");
  endSet.className="color-set";
  endSet.style.display="none";
function rebuildEndSet() {
  endSet.innerHTML = "";   // ğŸ”¥ CLEAR OLD INPUTS FIRST

  const withAlpha = modeSelect.value === "color4";

  createColorSet(
    endSet,
    data?.end || { r: 255, g: 0, b: 0, a: 255 },
    withAlpha
  );
}


rebuildEndSet();

  row.appendChild(endSet);

  if(data?.end) endToggle.checked=true;

function updateVisibility(){

  const mode = modeSelect.value;
  const allowsEnd = (mode === "color" || mode === "color4");
  const usesAlpha = (mode === "color4" || mode === "solid4");

  // ğŸ”¥ Toggle alpha on START set
  const startAlpha = startSet.querySelector(".a");
  if(startAlpha){
    startAlpha.style.display = usesAlpha ? "inline-block" : "none";
  }

  // ğŸ”¥ Toggle End checkbox visibility
  endWrapper.style.display = allowsEnd ? "flex" : "none";

  // ğŸ”¥ Toggle END color-set
  if(allowsEnd && endToggle.checked){
    endSet.style.display = "flex";

    const endAlpha = endSet.querySelector(".a");
    if(endAlpha){
      endAlpha.style.display = (mode === "color4") ? "inline-block" : "none";
    }

  } else {
    endSet.style.display = "none";
  }

  updatePreview();
}



modeSelect.addEventListener("change", () => {
  rebuildStartSet();
  updateVisibility();
});

  endToggle.addEventListener("change",updateVisibility);


// DELETE BUTTON
const deleteBtn = document.createElement("button");
deleteBtn.className = "delete-btn";
deleteBtn.innerHTML = `
<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
  <polyline points="3 6 5 6 21 6"/>
  <path d="M19 6l-1 14H6L5 6"/>
  <path d="M10 11v6"/>
  <path d="M14 11v6"/>
  <path d="M9 6V4h6v2"/>
</svg>
`;

deleteBtn.addEventListener("click", () => {
  const allRows = document.querySelectorAll(".row");
  if (allRows.length <= 1) return;
  row.remove();
  updatePreview();
});

row.appendChild(deleteBtn);




  rowsContainer.appendChild(row);
  updateVisibility();
}

function sortRows() {
  const rows = [...document.querySelectorAll(".row")];

  rows.sort((a, b) => {
    return (parseFloat(a.querySelector(".value").value) || 0) -
           (parseFloat(b.querySelector(".value").value) || 0);
           
  });

  rows.forEach(row => rowsContainer.appendChild(row));
}


function updatePreview(){
  const rows=[...document.querySelectorAll(".row")];
  if(rows.length===0) return;

rows.sort((a,b)=>{
  return (parseFloat(a.querySelector(".value").value)||0) -
         (parseFloat(b.querySelector(".value").value)||0);
});

// ğŸ”¥ Visually reorder rows


  const values=rows.map(r=>parseFloat(r.querySelector(".value").value)||0);
  const min=Math.min(...values);
  const max=Math.max(...values);
  const range = max - min || 1;

  // Clear previous ticks
ticksContainer.innerHTML = "";

  let stops=[];

  for(let i=0;i<rows.length;i++){

    const row = rows[i];
    const value = parseFloat(row.querySelector(".value").value)||0;
    const percent = ((value-min)/range)*100;

    // Create tick
const tick = document.createElement("div");
tick.className = "tick";
tick.style.left = percent + "%";

tick.innerHTML = `
  <div class="tick-line"></div>
  <div>${value}</div>
`;

ticksContainer.appendChild(tick);


    const mode = row.querySelector(".mode").value;
    const useEnd = row.querySelector(".useEnd")?.checked;

    const sets = row.querySelectorAll(".color-set");
    const startSet = sets[0];
    const endSet = sets[1];

    const r = startSet.querySelector(".r").value;
    const g = startSet.querySelector(".g").value;
    const b = startSet.querySelector(".b").value;
    const a = startSet.querySelector(".a")?.value ?? 255;

    const startColor = mode.includes("4")
      ? `rgba(${r},${g},${b},${a/255})`
      : `rgb(${r},${g},${b})`;

    // Always push starting stop
    stops.push(`${startColor} ${percent}%`);

    // If last row, stop here
    if(i === rows.length-1) break;

    const nextRow = rows[i+1];
    const nextValue = parseFloat(nextRow.querySelector(".value").value)||0;
    const nextPercent = ((nextValue-min)/range)*100;

    if(mode === "color" || mode === "color4"){
      if(useEnd && endSet){

        const r2 = endSet.querySelector(".r").value;
        const g2 = endSet.querySelector(".g").value;
        const b2 = endSet.querySelector(".b").value;
        const a2 = endSet.querySelector(".a")?.value ?? 255;

        const endColor = mode === "color4"
          ? `rgba(${r2},${g2},${b2},${a2/255})`
          : `rgb(${r2},${g2},${b2})`;

        stops.push(`${endColor} ${nextPercent}%`);
      }
      else{
        // Blend into next rowâ€™s start color naturally
        continue;
      }
    }

    if(mode === "solid" || mode === "solid4"){
      stops.push(`${startColor} ${nextPercent}%`);
    }
  }

  preview.style.background = `linear-gradient(to right, ${stops.join(",")})`;
}


function downloadPAL(){
  const rows=[...document.querySelectorAll(".row")];

  // ğŸ”¥ Sort rows by value before export
  rows.sort((a,b)=>{
    return (parseFloat(a.querySelector(".value").value)||0) -
           (parseFloat(b.querySelector(".value").value)||0);
  });

  // ğŸ”¥ Grab meta values
  const product = document.getElementById("product").value || "";
  const units   = document.getElementById("units").value   || "";
  const scale   = document.getElementById("scale").value   || "";
  const offset  = document.getElementById("offset").value  || "";
  const step    = document.getElementById("step").value    || "";

  let content = "";

  // âœ… First two required rows
  content += `Product: ${product}\n`;
  content += `Units: ${units}\n`;

  // Optional extras (only write if filled in)
  if(scale)  content += `Scale: ${scale}\n`;
  if(offset) content += `Offset: ${offset}\n`;
  if(step)   content += `Step: ${step}\n`;

  content += `\n`;

  rows.forEach(row=>{
    const val=row.querySelector(".value").value;
    const mode=row.querySelector(".mode").value;

    const sets = row.querySelectorAll(".color-set");
    const start = sets[0];
    const end = sets[1];

    const r=start.querySelector(".r").value;
    const g=start.querySelector(".g").value;
    const b=start.querySelector(".b").value;
    const a=start.querySelector(".a")?.value;

    const useEnd = row.querySelector(".useEnd")?.checked;

    if(mode==="solid"){
      content+=`SolidColor: ${val} ${r} ${g} ${b}\n`;
    }

    if(mode==="solid4"){
      content+=`SolidColor4: ${val} ${r} ${g} ${b} ${a}\n`;
    }

    if(mode==="color"){
      content+=`Color: ${val} ${r} ${g} ${b}`;
      if(useEnd && end){
        const r2=end.querySelector(".r").value;
        const g2=end.querySelector(".g").value;
        const b2=end.querySelector(".b").value;
        content+=` ${r2} ${g2} ${b2}`;
      }
      content+="\n";
    }

    if(mode==="color4"){
      content+=`Color4: ${val} ${r} ${g} ${b} ${a}`;
      if(useEnd && end){
        const r2=end.querySelector(".r").value;
        const g2=end.querySelector(".g").value;
        const b2=end.querySelector(".b").value;
        const a2=end.querySelector(".a")?.value ?? 255;
        content+=` ${r2} ${g2} ${b2} ${a2}`;
      }
      content+="\n";
    }
  });

  const blob=new Blob([content],{type:"text/plain"});
  const aTag=document.createElement("a");
  aTag.href=URL.createObjectURL(blob);
  aTag.download="colortable.pal";
  aTag.click();
}



// Load default table on startup
defaultTable.forEach(row => addRow(row));
updatePreview();

</script>
</div>
<footer>
  <p>
    Designed for <a href="https://www.weatherwise.app/" target="_blank" style="text-decoration: none;">WeatherWise</a> and compatible radar software.
  </p>
  <p class="disclaimer">
    WeatherWise is a registered trademark of its respective owner.
    This site is not affiliated with or endorsed by WeatherWise.
  </p>
  <p class="mono">
  Created by Bryant Almany / Almany Designs
</p>

</footer>
</body>

</html>
