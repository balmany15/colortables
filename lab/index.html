<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WeatherWise Color Lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../main.css">

<style>

.lab-container {
  max-width: 1100px;
  margin: 60px auto;
  padding: 0 20px;
}

.preview-wrapper {
  background: #111827;
  border: 1px solid #1f2937;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 40px;
}

#preview {
  width: 100%;
  height: 70px;
  border-radius: 8px;
  display: block;
}

.meta-controls {
  display: flex;
  gap: 12px;
  margin-bottom: 40px;
  flex-wrap: wrap;
}

.meta-controls input {
  padding: 8px 10px;
  background: #0d1117;
  border: 1px solid #1f2937;
  color: #e6edf3;
  border-radius: 6px;
}

.lab-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  background: #111827;
  border: 1px solid #1f2937;
  border-radius: 10px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.lab-row input[type="number"],
.lab-row input[type="text"] {
  width: 80px;
}

.lab-row input[type="color"] {
  width: 40px;
  height: 40px;
  padding: 0;
  border: none;
  cursor: pointer;
}

.lab-row select {
  background: #0d1117;
  border: 1px solid #1f2937;
  color: #e6edf3;
  padding: 6px;
  border-radius: 6px;
}

.lab-row button {
  padding: 6px 10px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 13px;
}

.remove-btn {
  background: #dc2626;
  color: white;
}

.add-row-btn {
  margin-top: 15px;
  padding: 8px 16px;
  background: #38bdf8;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

.lab-export {
  margin-top: 40px;
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.lab-export input {
  padding: 8px 10px;
  background: #0d1117;
  border: 1px solid #1f2937;
  color: #e6edf3;
  border-radius: 6px;
}

.lab-export button {
  padding: 10px 18px;
  background: #38bdf8;
  color: #0d1117;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}

</style>
</head>

<body>

<header>
  <h1 class="logo-heading">
    <span class="brand">
      Weather<span class="accent">Wise</span>
    </span>
    Color Lab
  </h1>
</header>

<main class="lab-container">

<div class="preview-wrapper">
  <canvas id="preview"></canvas>
</div>

<div class="meta-controls">
  <input type="text" id="product" placeholder="Product (BR)">
  <input type="text" id="units" placeholder="Units (dBZ)">
  <input type="number" id="step" placeholder="Step">
</div>

<div id="rows"></div>
<button class="add-row-btn" onclick="addRow()">Add Row</button>

<div class="lab-export">
  <input type="text" id="filename" placeholder="File Name">
  <button onclick="downloadPal()">Download .PAL</button>
</div>

</main>

<script>

let rows = [];

function addRow() {
  rows.push({
    value: 0,
    mode: "color",
    gradient: false,
    start: { r: 255, g: 255, b: 255, a: 255 },
    end: { r: 255, g: 255, b: 255, a: 255 }
  });
  renderRows();
  renderPreview();
}

function renderRows() {
  const container = document.getElementById("rows");
  container.innerHTML = "";

  rows.forEach((row, index) => {

    const div = document.createElement("div");
    div.className = "lab-row";

    const valueInput = document.createElement("input");
    valueInput.type = "number";
    valueInput.value = row.value;
    valueInput.oninput = () => {
      row.value = parseFloat(valueInput.value);
      renderPreview();
    };

    const modeSelect = document.createElement("select");
    ["solid","color","color4"].forEach(mode=>{
      const opt=document.createElement("option");
      opt.value=mode;
      opt.textContent=mode;
      if(row.mode===mode) opt.selected=true;
      modeSelect.appendChild(opt);
    });
    modeSelect.onchange=()=>{
      row.mode=modeSelect.value;
      renderPreview();
    };

    const gradientToggle = document.createElement("input");
    gradientToggle.type="checkbox";
    gradientToggle.checked=row.gradient;
    gradientToggle.onchange=()=>{
      row.gradient=gradientToggle.checked;
      renderPreview();
    };

    const startHex = createHexInput(row.start, (rgb)=>{
      row.start = rgb;
      if(row.mode==="solid") row.end={...rgb};
      renderPreview();
    });

    const startPicker = createColorPicker(row.start, (rgb)=>{
      row.start = rgb;
      if(row.mode==="solid") row.end={...rgb};
      startHex.value = rgbToHex(rgb);
      renderPreview();
    });

    const endHex = createHexInput(row.end, (rgb)=>{
      row.end = rgb;
      renderPreview();
    });

    const endPicker = createColorPicker(row.end, (rgb)=>{
      row.end = rgb;
      endHex.value = rgbToHex(rgb);
      renderPreview();
    });

    const alphaInput = document.createElement("input");
    alphaInput.type="number";
    alphaInput.min=0;
    alphaInput.max=255;
    alphaInput.value=row.start.a;
    alphaInput.oninput=()=>{
      row.start.a=parseInt(alphaInput.value)||255;
      renderPreview();
    };

    const remove=document.createElement("button");
    remove.className="remove-btn";
    remove.textContent="X";
    remove.onclick=()=>{
      rows.splice(index,1);
      renderRows();
      renderPreview();
    };

    div.append(
      valueInput,
      modeSelect,
      gradientToggle,
      startHex,
      startPicker,
      endHex,
      endPicker,
      alphaInput,
      remove
    );

    container.appendChild(div);
  });
}

function renderPreview() {
  const canvas=document.getElementById("preview");
  const ctx=canvas.getContext("2d");

  canvas.width=canvas.clientWidth;
  canvas.height=canvas.clientHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!rows.length) return;

  const sorted=[...rows].sort((a,b)=>a.value-b.value);
  const min=sorted[0].value;
  const max=sorted[sorted.length-1].value;
  if(min===max) return;

  for(let i=0;i<sorted.length;i++){
    const row=sorted[i];
    const next=sorted[i+1];

    const startX=((row.value-min)/(max-min))*canvas.width;
    const endX=next?((next.value-min)/(max-min))*canvas.width:canvas.width;
    const width=endX-startX;

    if(row.mode==="solid"||!next){
      ctx.fillStyle=rgba(row.start);
      ctx.fillRect(startX,0,width,canvas.height);
      continue;
    }

    const grad=ctx.createLinearGradient(startX,0,endX,0);

    if(row.gradient){
      grad.addColorStop(0,rgba(row.start));
      grad.addColorStop(1,rgba(row.end));
    } else {
      grad.addColorStop(0,rgba(row.start));
      grad.addColorStop(1,rgba(next.start));
    }

    ctx.fillStyle=grad;
    ctx.fillRect(startX,0,width,canvas.height);
  }
}

function downloadPal(){
  if(!rows.length) return;

  const product=document.getElementById("product").value||"BR";
  const units=document.getElementById("units").value||"dBZ";
  const step=document.getElementById("step").value||5;
  const filename=document.getElementById("filename").value||"colortable";

  let content=`product: ${product}\nunits: ${units}\nstep: ${step}\n\n`;

  const sorted=[...rows].sort((a,b)=>a.value-b.value);

  sorted.forEach(row=>{
    if(row.mode==="solid"){
      content+=`solidcolor: ${row.value} ${row.start.r} ${row.start.g} ${row.start.b}\n`;
    }
    else if(row.mode==="color"){
      if(row.gradient){
        content+=`color: ${row.value} ${row.start.r} ${row.start.g} ${row.start.b} ${row.end.r} ${row.end.g} ${row.end.b}\n`;
      } else {
        content+=`color: ${row.value} ${row.start.r} ${row.start.g} ${row.start.b}\n`;
      }
    }
    else if(row.mode==="color4"){
      content+=`color4: ${row.value} ${row.start.r} ${row.start.g} ${row.start.b} ${row.start.a}\n`;
    }
  });

  const blob=new Blob([content],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename+".pal";
  a.click();
}

function rgba({r,g,b,a=255}) {
  return `rgba(${r},${g},${b},${a/255})`;
}

function rgbToHex({r,g,b}) {
  return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("");
}

function hexToRgb(hex){
  const bigint=parseInt(hex.slice(1),16);
  return {
    r:(bigint>>16)&255,
    g:(bigint>>8)&255,
    b:bigint&255,
    a:255
  };
}

function createHexInput(color,callback){
  const input=document.createElement("input");
  input.type="text";
  input.value=rgbToHex(color);
  input.oninput=()=>{
    if(/^#([0-9A-F]{3}){1,2}$/i.test(input.value)){
      callback(hexToRgb(input.value));
    }
  };
  return input;
}

function createColorPicker(color,callback){
  const input=document.createElement("input");
  input.type="color";
  input.value=rgbToHex(color);
  input.oninput=()=>{
    callback(hexToRgb(input.value));
  };
  return input;
}

addRow();

</script>

</body>
</html>
